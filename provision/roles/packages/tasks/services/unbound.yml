---
- name: install unbound service
  homebrew: name=unbound state=latest
  register: unbound_installed

- name: ensure unbound directories
  file: path={{item}} state=directory
  with_items:
    - ~/.local/etc/unbound
    - ~/.local/var/log

- name: updating unbound configurations
  template:
    src: home/local/etc/unbound/unbound.conf.j2
    dest: "{{ansible_env['HOME']}}/.local/etc/unbound/unbound.conf"
  register: unbound_configured

- name: enabling unbound service
  template:
    src: home/Library/LaunchAgents/net.unbound.unbound.plist.j2
    dest: ~/Library/LaunchAgents/net.unbound.unbound.plist
  register: unbound_enabled

- name: ensuring resolver directory
  become: yes
  file:
    path: /etc/resolver
    state: directory

- name: adding dev resolvers
  become: yes
  copy:
    src: etc/resolver/dev
    dest: /etc/resolver/dev

- name: unloading unbound service
  command: launchctl unload ~/Library/LaunchAgents/net.unbound.unbound.plist
  ignore_errors: yes
  when: "unbound_configured.changed or unbound_enabled.changed or unbound_installed.changed"

- name: loading unbound service
  command: launchctl load ~/Library/LaunchAgents/net.unbound.unbound.plist
  ignore_errors: yes
  when: "unbound_configured.changed or unbound_enabled.changed or unbound_installed.changed"
