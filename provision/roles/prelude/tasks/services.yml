---
- name: install homebrew services
  homebrew: name={{item}} state=latest
  with_items: "{{services}}"
  register: service_installed

- name: ensuring service directory
  file:
    path: ~/Library/LaunchAgents
    state: directory

- name: enabling homebrew services
  file:
    src: /usr/local/opt/{{item}}/homebrew.mxcl.{{item}}.plist
    path: ~/Library/LaunchAgents/homebrew.mxcl.{{item}}.plist
    state: link
    force: yes
  with_items: "{{services}}"
  register: service_enabled

- name: unloading services
  command: launchctl unload ~/Library/LaunchAgents/homebrew.mxcl.{{item}}.plist
  ignore_errors: yes
  with_items: "{{services}}"
  when: "service_installed.changed or service_enabled.changed"

- name: loading services
  command: launchctl load ~/Library/LaunchAgents/homebrew.mxcl.{{item}}.plist
  ignore_errors: yes
  with_items: "{{services}}"
  when: "service_installed.changed or service_enabled.changed"
